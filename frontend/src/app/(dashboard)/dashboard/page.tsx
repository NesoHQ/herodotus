'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { getRealtimeStats, getOverviewStats, getDomains, getAPIKeys } from '@/lib/api';
import type { RealtimeStats, OverviewStats, Domain } from '@/types';
import GettingStarted from '@/components/onboarding/GettingStarted';
import EmptyState from '@/components/ui/EmptyState';
import Alert from '@/components/ui/Alert';
import { Card } from '@/components/ui/card';

// Dashboard Components
import DashboardHeader from '@/components/dashboard/DashboardHeader';
import MetricsCards from '@/components/dashboard/MetricsCards';
import TrafficChart from '@/components/dashboard/TrafficChart';
import TopPages from '@/components/dashboard/TopPages';
import TopReferrers from '@/components/dashboard/TopReferrers';
import DeviceStats from '@/components/dashboard/DeviceStats';
import BrowserStats from '@/components/dashboard/BrowserStats';
import CountryStats from '@/components/dashboard/CountryStats';
import DomainInfoCard from '@/components/dashboard/DomainInfoCard';

// Custom hook for dashboard data management
function useDashboardData() {
  const [domains, setDomains] = useState<Domain[]>([]);
  const [selectedDomain, setSelectedDomain] = useState<string>('');
  const [realtimeStats, setRealtimeStats] = useState<RealtimeStats | null>(null);
  const [overviewStats, setOverviewStats] = useState<OverviewStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [hasAPIKeys, setHasAPIKeys] = useState(false);
  const [lastUpdate, setLastUpdate] = useState<Date>(new Date());

  const loadInitialData = async () => {
    try {
      const [domainsRes, keysRes] = await Promise.all([
        getDomains(),
        getAPIKeys(),
      ]);
      
      setDomains(domainsRes.data || []);
      setHasAPIKeys((keysRes.data || []).length > 0);
      
      if (domainsRes.data && domainsRes.data.length > 0) {
        setSelectedDomain(domainsRes.data[0].id);
      }
    } catch (error) {
      console.error('Failed to load initial data:', error);
      setDomains([]);
    } finally {
      setLoading(false);
    }
  };

  const loadStats = async () => {
    if (!selectedDomain) return;

    try {
      const [realtime, overview] = await Promise.all([
        getRealtimeStats(selectedDomain),
        getOverviewStats(selectedDomain),
      ]);
      
      // Convert UTC times to local timezone
      if (realtime.data?.hits_per_minute) {
        realtime.data.hits_per_minute = realtime.data.hits_per_minute.map(item => {
          const [hours, minutes] = item.minute.split(':');
          const utcDate = new Date();
          utcDate.setUTCHours(parseInt(hours), parseInt(minutes), 0, 0);
          
          const localTime = utcDate.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          });
          
          return { ...item, minute: localTime };
        });
      }
      
      setRealtimeStats(realtime.data);
      setOverviewStats(overview.data);
    } catch (error) {
      console.error('Failed to load stats:', error);
    }
  };

  useEffect(() => {
    loadInitialData();
  }, []);

  useEffect(() => {
    if (selectedDomain) {
      loadStats();
      const interval = setInterval(() => {
        loadStats();
        setLastUpdate(new Date());
      }, 5000);
      return () => clearInterval(interval);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedDomain]);

  return {
    domains,
    selectedDomain,
    setSelectedDomain,
    realtimeStats,
    overviewStats,
    loading,
    hasAPIKeys,
    lastUpdate,
  };
}

export default function DashboardPage() {
  const router = useRouter();
  const {
    domains,
    selectedDomain,
    setSelectedDomain,
    realtimeStats,
    overviewStats,
    loading,
    hasAPIKeys,
    lastUpdate,
  } = useDashboardData();

  const hasTrackedEvents = (overviewStats?.total_hits || 0) > 0;
  const selectedDomainData = domains.find(d => d.id === selectedDomain);

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Loading your analytics...</p>
        </div>
      </div>
    );
  }

  if (domains.length === 0) {
    return (
      <div className="max-w-4xl mx-auto">
        <EmptyState
          icon="ðŸŒ"
          title="Welcome to Krakens Analytics!"
          description="Get started by adding your first domain. Once you add a domain and install the tracking code, you'll see real-time analytics here."
          action={{
            label: '+ Add Your First Domain',
            onClick: () => router.push('/domains'),
          }}
        />
        
        <div className="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card className="text-center p-6 bg-primary/5">
            <div className="text-4xl mb-3">ðŸ“Š</div>
            <h3 className="font-semibold mb-2">Real-Time Analytics</h3>
            <p className="text-sm text-muted-foreground">Track visitors, page views, and user behavior in real-time</p>
          </Card>
          <Card className="text-center p-6 bg-accent/5">
            <div className="text-4xl mb-3">ðŸ”’</div>
            <h3 className="font-semibold mb-2">Privacy-First</h3>
            <p className="text-sm text-muted-foreground">IP anonymization and GDPR-compliant tracking</p>
          </Card>
          <Card className="text-center p-6 bg-success/5">
            <div className="text-4xl mb-3">âš¡</div>
            <h3 className="font-semibold mb-2">Lightweight SDK</h3>
            <p className="text-sm text-muted-foreground">Less than 5KB tracking script, no impact on performance</p>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <DashboardHeader
        lastUpdate={lastUpdate}
        domains={domains}
        selectedDomain={selectedDomain}
        onDomainChange={setSelectedDomain}
      />

      <GettingStarted
        hasDomains={domains.length > 0}
        hasAPIKeys={hasAPIKeys}
        hasTrackedEvents={hasTrackedEvents}
      />

      {!hasTrackedEvents && (
        <Alert
          type="info"
          title="No data yet"
          message="Install the tracking code on your website to start collecting analytics. Go to API Keys to generate your tracking key."
        />
      )}

      <MetricsCards realtimeStats={realtimeStats} overviewStats={overviewStats} />

      <TrafficChart realtimeStats={realtimeStats} />

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <TopPages realtimeStats={realtimeStats} />
        <TopReferrers realtimeStats={realtimeStats} />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <DeviceStats realtimeStats={realtimeStats} />
        <BrowserStats realtimeStats={realtimeStats} />
        <CountryStats realtimeStats={realtimeStats} />
      </div>

      {selectedDomainData && <DomainInfoCard domain={selectedDomainData} />}
    </div>
  );
}
